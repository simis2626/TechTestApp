# Architecture

# Initial Sketch Plan
To get a rough idea of the initial plan, [this sketch](https://drive.google.com/file/d/1hXsk8ZEmxIllxzusgBcEIPhh6iTS2Qfh/view?usp=sharing) was completed to keep the workflow structured.

# Architecture Diagram
An Architecture Diagram of the solution and the way the cloud build steps orchestrate the deployment is available [in Google Drive](https://drive.google.com/open?id=12DgV6AWKf4j6okznSyTv5YGDuAt19QZ9)

# Cloud Build Steps
1. calc-safe-instance-name

    CloudSQL Instances can only use lowercase alphanumeric and hyphens.<br/>
    This script creates an instance name, and saves it to a well known location on disk.

1. create-gcs-bucket

    A GCS bucket is required to store the encrypted database password and SSL certs and keys.

1. decrypt-cloudsql-updatedb-cred

    Limitations of Cloud Build (Doesnt' support unix socket connections to CloudSQL natively, TechTestApp doesn't support SSL based DB connections) meant that the CloudSQLProxy is used to connect to CloudSQL for the updatedb stage, this requires a separate Service Account, generated by the user on initial setup and stored in the repo in the root directory. That file is decrypted in this step to be made available for update-db use.
    
1. create-cloud-sql

    Creates the CloudSQL instance. Stores the root db password (encrypted with CLoudKMS) and SSL key, certs and CA in the GCS bucket.

1. create-sql-database

    Adds the 'app' database to the CloudSQL instance.

1. build-docker

    Performs a docker build of the application.

1. publish-docker

    Pushes the built docker image

1. update-db

    Runs the CloudSQL proxy which allows connection over unix sockets to the CloudSQL instance, and then uses the recently built docker image to run the updatedb command (-s as the database is managed by the build pipeline)


1. deploy-cloud-run

    Deploys the application to Cloud Run.